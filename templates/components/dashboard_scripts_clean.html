<!-- Clean Dashboard Scripts - Essential Functions Only -->
<script>
// Global variables
let userProfile = null;

// ===== CORE NAVIGATION =====
function showSection(sectionName) {
    console.log('üéØ showSection called with: ' + sectionName);
    
    // Hide all sections
    const allSections = document.querySelectorAll('.dashboard-section');
    allSections.forEach(section => {
        section.style.display = 'none';
        section.style.visibility = 'hidden';
        section.style.opacity = '0';
    });
    
    // Show target section
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
        targetSection.style.visibility = 'visible';
        targetSection.style.opacity = '1';
        console.log('‚úÖ Section displayed:', sectionName);
        
        // Update navigation
        updateNavigationActiveState(sectionName);
        
        // Load section-specific data
        loadSectionData(sectionName);
    } else {
        console.error('‚ùå Section not found:', sectionName + '-section');
    }
}

function updateNavigationActiveState(sectionName) {
    // Update main navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    const clickedLink = document.querySelector(`[onclick*="showSection('${sectionName}')"]`);
    if (clickedLink) {
        clickedLink.classList.add('active');
    }
    
    // Update Next-Gen bottom navigation
    document.querySelectorAll('.nextgen-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const nextgenNavItem = document.querySelector(`.nextgen-nav-item[onclick*="${sectionName}"]`);
    if (nextgenNavItem) {
        nextgenNavItem.classList.add('active');
    }
}

function loadSectionData(sectionName) {
    console.log('üìÇ Loading data for section:', sectionName);
    
    switch(sectionName) {
        case 'properties':
            if (typeof loadUserProperties === 'function') loadUserProperties();
            break;
        case 'facebook':
            loadFacebookStatus();
            break;
        case 'onboarding':
            // Use our simple onboarding functions from the main template
            if (typeof showOnboardingSection === 'function') {
                showOnboardingSection();
            }
            break;
    }
}

// ===== OAUTH HANDLING =====
function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const auth = urlParams.get('auth');
    const token = urlParams.get('token');
    
    if (auth === 'success' && token) {
        console.log('üîê OAuth success, storing token');
        localStorage.setItem('access_token', token);
        
        // Clean up URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        showAlert('Successfully connected to Facebook!', 'success');
        showSection('welcome');
    }
}

// ===== PROPERTY MANAGEMENT =====
async function loadUserProperties() {
    console.log('üè† Loading user properties...');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/v1/properties/', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayProperties(data.properties || []);
        } else {
            console.warn('Failed to load properties, using fallback');
            displayProperties([]);
        }
    } catch (error) {
        console.error('Error loading properties:', error);
        displayProperties([]);
    }
}

function displayProperties(properties) {
    const container = document.getElementById('propertiesContainer');
    if (!container) return;
    
    if (properties.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-home fa-3x text-muted mb-3"></i>
                <h5>No Properties Yet</h5>
                <p class="text-muted">Add your first property to get started with AI content generation.</p>
                <button class="btn btn-primary" onclick="showAddPropertyModal()">
                    <i class="fas fa-plus me-2"></i>Add Property
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = properties.map(property => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="glass-card h-100">
                <h6>${property.title || 'Untitled Property'}</h6>
                <p class="text-muted small">${property.location || 'Location not specified'}</p>
                <p class="text-muted small">‚Çπ${property.price || 'Price not set'}</p>
                <button class="btn btn-sm btn-outline-success" onclick="generateContentForProperty('${property.id}')">
                    <i class="fas fa-robot me-1"></i>Generate Content
                </button>
            </div>
        </div>
    `).join('');
}

// ===== AI CONTENT GENERATION =====
async function generateContentForProperty(propertyId) {
    console.log('ü§ñ Generating content for property:', propertyId);
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    button.disabled = true;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/v1/ai/generate-content/${propertyId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            showAlert('Content generated successfully!', 'success');
            console.log('Generated content:', data);
        } else {
            throw new Error('Failed to generate content');
        }
    } catch (error) {
        console.error('Error generating content:', error);
        showAlert('Failed to generate content. Please try again.', 'danger');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// ===== FACEBOOK INTEGRATION =====
function loadFacebookStatus() {
    const token = localStorage.getItem('access_token');
    if (token) {
        const statusElement = document.getElementById('facebookConnectionStatus');
        if (statusElement) {
            statusElement.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-2"></i>Connected</span>';
        }
    }
}

// ===== UTILITY FUNCTIONS =====
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = 
        message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function showAddPropertyModal() {
    const modalElement = document.getElementById('addPropertyModal');
    if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        showAlert('Property modal not available', 'warning');
    }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Clean dashboard scripts loaded');
    
    // Handle OAuth callback
    handleOAuthCallback();
    
    // Initialize dashboard if function exists
    if (typeof window.dashboardInit?.startDashboardInitialization === 'function') {
        window.dashboardInit.startDashboardInitialization();
    }
});

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (window.location.hash) {
        history.replaceState(null, null, window.location.pathname + window.location.search);
    }
});

// Essential onboarding functions
function showOnboardingSection() {
    console.log('‚úÖ showOnboardingSection called');
    showOnboardingStep(1);
}

function nextOnboardingStep() {
    console.log('‚úÖ nextOnboardingStep called');
    
    // Get current active step
    const currentStepElement = document.querySelector('.onboarding-step:not([style*="display: none"])');
    if (!currentStepElement) return;
    
    const currentStep = parseInt(currentStepElement.dataset.step || '1');
    const nextStep = currentStep + 1;
    
    // Hide current step
    currentStepElement.style.display = 'none';
    
    // Show next step or complete
    const nextStepElement = document.querySelector(`[data-step="${nextStep}"]`);
    if (nextStepElement) {
        nextStepElement.style.display = 'block';
    } else {
        alert('Onboarding completed! Redirecting to dashboard...');
        if (window.dashboardCore && window.dashboardCore.showSection) {
            window.dashboardCore.showSection('welcome');
        }
    }
}

function showOnboardingStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('[data-step]').forEach(step => {
        step.style.display = 'none';
    });
    
    // Show target step
    const targetStep = document.querySelector(`[data-step="${stepNumber}"]`);
    if (targetStep) {
        targetStep.style.display = 'block';
    }
}


console.log('‚úÖ Clean dashboard scripts loaded successfully');
</script>
