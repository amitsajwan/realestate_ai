<!-- Dashboard JavaScript Functions Component -->
<script>
// Dashboard functionality
let currentSection = 'welcome';
let userProfile = null; // ‚úÖ Add missing userProfile variable

// ‚úÖ IMPROVED: Handle OAuth callback and store token
function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const auth = urlParams.get('auth');
    const token = urlParams.get('token');
    const fromOnboarding = urlParams.get('fromOnboarding');
    
    if (auth === 'success' && token) {
        console.log('üîê OAuth success, storing token');
        localStorage.setItem('access_token', token);
        
        // Clean up URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // If coming from onboarding, complete the Facebook step
        if (fromOnboarding === 'true') {
            console.log('üîÑ Facebook OAuth completed during onboarding');
            
            // Mark Facebook step as completed
            const facebookStatus = document.getElementById('facebookStatus');
            if (facebookStatus) {
                facebookStatus.style.display = 'block';
            }
            
            // Hide Facebook setup forms
            const quickSetup = document.getElementById('facebookQuickSetup');
            const customSetup = document.getElementById('facebookCustomSetup');
            if (quickSetup) quickSetup.style.display = 'none';
            if (customSetup) customSetup.style.display = 'none';
            
            // Show success message
            showAlert('‚úÖ Facebook connected successfully! You can now proceed to the next step.', 'success');
            
            // Auto-save onboarding data
            saveOnboardingFormData();
            
            // Stay on onboarding step 4 (Facebook Integration)
            showOnboardingStep(4);
            
        } else {
            // Regular OAuth callback - go to dashboard
            console.log('üîê Regular OAuth callback, going to dashboard');
            showSection('welcome');
        }
        
        // Extract user info from token
        try {
            const tokenParts = token.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                console.log('‚úÖ Token stored, user_id:', payload.user_id);
            }
        } catch (e) {
            console.warn('Failed to decode token payload');
        }
    } else {
        console.log('No OAuth callback detected');
    }
}

// ‚úÖ ADDED: loadProperties function (alias for loadUserProperties)
function loadProperties() {
    loadUserProperties();
}

// Show different sections
function showSection(sectionName) {
    console.log(`üéØ showSection called with: ${sectionName}`);
    
    // Hide all sections
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionName + '-section');
    console.log(`üîç Looking for section: ${sectionName}-section`);
    console.log(`üîç Found element:`, targetSection);
    
    if (targetSection) {
        targetSection.style.display = 'block';
        currentSection = sectionName;
        console.log(`‚úÖ Section ${sectionName} displayed successfully`);
        
        // Update navigation active state
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        // Find the clicked navigation link and mark it as active
        const clickedLink = document.querySelector(`[onclick*="showSection('${sectionName}')"]`);
        if (clickedLink) {
            clickedLink.classList.add('active');
            console.log(`‚úÖ Navigation link marked as active`);
        } else {
            console.log(`‚ö†Ô∏è Could not find navigation link for ${sectionName}`);
        }
        
        // Load section-specific data
        loadSectionData(sectionName);
        
        // Special handling for onboarding section
        if (sectionName === 'onboarding') {
            // Load user profile data into form if available
            loadUserProfileIntoOnboardingForm();
            
            // Load any saved form data
            loadOnboardingFormData();
            
            // Reset onboarding to first step when showing
            currentOnboardingStep = 1;
            updateOnboardingProgress();
            updateOnboardingNavigation();
            
            // Show first step
            document.querySelectorAll('.onboarding-step').forEach(step => {
                step.classList.remove('active');
            });
            const firstStep = document.getElementById('step1');
            if (firstStep) firstStep.classList.add('active');
        }
    } else {
        console.error(`‚ùå Section ${sectionName}-section not found!`);
        console.log(`üîç Available sections:`, Array.from(document.querySelectorAll('.dashboard-section')).map(s => s.id));
    }
}

// Load data for specific sections
function loadSectionData(sectionName) {
    switch(sectionName) {
        case 'welcome':
            loadDashboardStats();
            break;
        case 'ai-content':
            loadFacebookPages();
            // ‚úÖ Load properties for AI Content dropdown
            loadUserProperties();
            // Load user profile for content generation
            if (!userProfile) {
                loadUserProfile();
            }
            break;
        case 'facebook':
            loadFacebookStatus();
            loadFacebookPages();
            loadPostingHistory();
            break;
        case 'properties':
            loadUserProperties();
            break;
        case 'onboarding':
            // Initialize onboarding when section is loaded
            initOnboarding();
            break;
        case 'leads':
            loadLeads();
            break;
    }
}

// ‚úÖ FIXED: Load dashboard statistics
async function loadDashboardStats() {
    try {
        // Update time
        updateCurrentTime();
        
        // Load stats from API
        const response = await fetch('/api/v1/dashboard/stats');
        if (response.ok) {
            const data = await response.json();
            
            // Handle different response formats
            let stats = {};
            if (data && typeof data === 'object') {
                stats = data;
            } else {
                console.warn('Dashboard stats API returned unexpected format:', data);
                stats = {};
            }
            
            // Update stats with null checks
            const totalPropertiesEl = document.getElementById('totalProperties');
            const aiGeneratedEl = document.getElementById('aiGenerated');
            const facebookPostsEl = document.getElementById('facebookPosts');
            const totalLeadsEl = document.getElementById('totalLeads');
            
            if (totalPropertiesEl) totalPropertiesEl.textContent = stats.totalProperties || 0;
            if (aiGeneratedEl) aiGeneratedEl.textContent = stats.aiGenerated || 0;
            if (facebookPostsEl) facebookPostsEl.textContent = stats.facebookPosts || 0;
            if (totalLeadsEl) totalLeadsEl.textContent = stats.totalLeads || 0;
        } else {
            console.error('Dashboard stats API returned status:', response.status);
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// Update current time
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

// ‚úÖ IMPROVED: Check authentication status
function checkAuthentication() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        console.log('‚ùå No access token found');
        showAlert('Please login to continue', 'warning');
        // Redirect to login or show login modal
        return false;
    }

    // Validate token format
    try {
        const tokenParts = token.split('.');
        if (tokenParts.length !== 3) {
            console.log('‚ùå Invalid token format');
            localStorage.removeItem('access_token');
            showAlert('Invalid token. Please login again.', 'warning');
            return false;
        }

        // Check if token is expired (basic check)
        const payload = JSON.parse(atob(tokenParts[1]));
        const exp = payload.exp * 1000; // Convert to milliseconds
        if (Date.now() > exp) {
            console.log('‚ùå Token expired');
            localStorage.removeItem('access_token');
            showAlert('Session expired. Please login again.', 'warning');
            return false;
        }

        console.log('‚úÖ Token is valid');
        return true;
    } catch (error) {
        console.error('‚ùå Token validation error:', error);
        localStorage.removeItem('access_token');
        showAlert('Token validation failed. Please login again.', 'warning');
        return false;
    }
}

// ‚úÖ SECURITY FIXED: Load user properties from database with proper user isolation
async function loadUserProperties() {
    try {
        // Check authentication first
        if (!checkAuthentication()) {
            return;
        }

        const token = localStorage.getItem('access_token');
        
        // ‚úÖ SECURITY: Extract actual user ID from JWT token
        let userId = 'default_user';
        try {
            const tokenParts = token.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                userId = payload.user_id || payload.sub || 'default_user';
                console.log(`üîê Loading properties for authenticated user: ${userId}`);
            }
        } catch (e) {
            console.warn('Failed to decode JWT, using default user ID');
            userId = 'default_user';
        }

        // ‚úÖ SECURITY: Call endpoint with actual user ID from token
        const response = await fetch(`/api/v1/properties/user/${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.status === 401) {
            console.log('‚ùå 401 Unauthorized - token may be invalid');
            localStorage.removeItem('access_token');
            showAlert('Authentication failed. Please login again.', 'danger');
            return;
        }

        if (response.ok) {
            const result = await response.json();
            if (result.success && result.properties) {
                displayProperties(result.properties);
                console.log(`‚úÖ Loaded ${result.properties.length} properties for user: ${userId}`);
            } else {
                console.log('No properties found or API error');
                displayProperties([]);
            }
        } else {
            console.log(`Failed to load properties: ${response.status}`);
            displayProperties([]);
        }
    } catch (error) {
        console.error('Error loading properties:', error);
        showAlert('Error loading properties. Please try again.', 'danger');
        displayProperties([]);
    }
}

// Display properties in the grid
function displayProperties(properties) {
    const propertiesGrid = document.getElementById('propertiesGrid');
    if (!propertiesGrid) return;

    if (!properties || properties.length === 0) {
        propertiesGrid.innerHTML = `
            <div class="col-12">
                <div class="empty-state text-center">
                    <i class="fas fa-home fa-3x text-muted mb-3"></i>
                    <h4>No Properties Yet</h4>
                    <p class="text-muted">Start by adding your first property to get started</p>
                    <button class="btn btn-primary" onclick="showAddPropertyModal()">
                        <i class="fas fa-plus me-2"></i>Add First Property
                    </button>
                </div>
            </div>
        `;
        return;
    }

    propertiesGrid.innerHTML = properties.map(property => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="property-card">
                <div class="property-image">
                    <i class="fas fa-home fa-2x text-white"></i>
                </div>
                <div class="property-details">
                    <h5 class="property-title">${property.title || `${property.type} in ${property.city}`}</h5>
                    <p class="property-location">
                        <i class="fas fa-map-marker-alt text-muted me-2"></i>
                        ${property.city || 'City'}, ${property.state || 'State'}
                    </p>
                    <div class="property-price">
                        <span class="price">‚Çπ${property.price?.toLocaleString() || '0'}</span>
                        <span class="unit">${property.price_unit || 'per sq ft'}</span>
                    </div>
                    <div class="property-specs">
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-bed me-1"></i>${property.bedrooms || 'N/A'}
                        </span>
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-ruler-combined me-1"></i>${property.carpet_area || 'N/A'} sq ft
                        </span>
                    </div>
                    <div class="quick-actions mt-3">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editProperty('${property.id || property.property_id || 'unknown'}')">
                            <i class="fas fa-edit me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-outline-success me-2" onclick="generateContentForProperty('${property.id || property.property_id || 'unknown'}')">
                            <i class="fas fa-magic me-1"></i>Generate Content
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty('${property.id || property.property_id || 'unknown'}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    // ‚úÖ Also update the AI Content property dropdown
    updateAIContentPropertyDropdown(properties);
}

// ‚úÖ NEW FUNCTION: Update AI Content property dropdown
function updateAIContentPropertyDropdown(properties) {
    const propertySelect = document.getElementById('propertySelect');
    if (propertySelect) {
        // Clear existing options
        propertySelect.innerHTML = '<option value="">Choose a property...</option>';
        
        if (properties && properties.length > 0) {
            properties.forEach(property => {
                const option = document.createElement('option');
                // Use the correct ID field
                option.value = property.id || property.property_id || 'unknown';
                option.textContent = `${property.title || property.type} - ${property.city || 'Unknown Location'}`;
                propertySelect.appendChild(option);
            });
            console.log(`‚úÖ Updated AI Content dropdown with ${properties.length} properties`);
        } else {
            propertySelect.innerHTML = '<option value="">No properties available - Add a property first</option>';
        }
    }
}

// ‚úÖ SECURITY FIXED: Save property to database with proper user isolation
async function savePropertyToDatabase(propertyData) {
    try {
        const token = localStorage.getItem('access_token');
        if (!token) {
            showAlert('No access token found. Please login again.', 'danger');
            return null;
        }

        // ‚úÖ SECURITY: Extract actual user ID from JWT token
        let userId = 'default_user';
        try {
            const tokenParts = token.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                userId = payload.user_id || payload.sub || 'default_user';
                console.log(`üîê Saving property for authenticated user: ${userId}`);
            }
        } catch (e) {
            console.warn('Failed to decode JWT, using default user ID');
            userId = 'default_user';
        }

        const response = await fetch('/api/v1/properties/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                ...propertyData,
                user_id: userId // ‚úÖ SECURITY: Use actual user ID from token
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showAlert('Property saved successfully!', 'success');
                hideAddPropertyModal();
                
                // ‚úÖ Get the property ID from the response
                const propertyId = result.property_id || result.property?.id;
                console.log(`‚úÖ Property saved with ID: ${propertyId}`);
                
                loadUserProperties(); // Refresh the list
                return propertyId;
            } else {
                showAlert('Failed to save property', 'danger');
                return null;
            }
        } else {
            showAlert('Failed to save property', 'danger');
            return null;
        }
    } catch (error) {
        console.error('Error saving property:', error);
        showAlert('Error saving property', 'danger');
        return null;
    }
}

// Property management functions
function showAddPropertyModal() {
    const modalElement = document.getElementById('addPropertyModal');
    if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        console.error('Bootstrap Modal not available or modal element not found');
        showAlert('Modal functionality not available', 'warning');
    }
}

// ‚úÖ SECURITY FIXED: Submit property with proper form handling
async function submitProperty() {
    try {
        // Get form data using FormData API
        const form = document.getElementById('addPropertyForm');
        if (!form) {
            throw new Error('Property form not found');
        }
        
        const formData = new FormData(form);
        
        // Extract form values
        const propertyType = formData.get('propertyType');
        const city = formData.get('city');
        const area = formData.get('area');
        const address = formData.get('address');
        const price = formData.get('price');
        const bedrooms = formData.get('bedrooms');
        const carpetArea = formData.get('carpetArea');
        const furnishing = formData.get('furnishing');
        const description = formData.get('description');
        
        // Get selected amenities
        const amenities = [];
        form.querySelectorAll('input[name="amenities"]:checked').forEach(checkbox => {
            amenities.push(checkbox.value);
        });
        
        // Validate required fields
        if (!propertyType || !city || !area || !price || !bedrooms || !carpetArea) {
            showAlert('Please fill in all required fields', 'warning');
            return;
        }
        
        const propertyData = {
            title: `${propertyType} in ${city}`,
            type: propertyType,
            bedrooms: bedrooms.toString(),
            price: parseFloat(price),
            price_unit: 'per sq ft',
            city: city,
            area: area,
            address: address || `${area}, ${city}`,
            carpet_area: parseFloat(carpetArea),
            built_up_area: parseFloat(carpetArea) * 1.2, // Estimate built-up area
            floor: 'Ground Floor',
            furnishing: furnishing || 'Semi-Furnished',
            possession: 'Ready to Move',
            amenities: amenities,
            description: description || ''
        };
        
        // Save to database using the new function
        const propertyId = await savePropertyToDatabase(propertyData);
        if (propertyId) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPropertyModal'));
            if (modal) {
                modal.hide();
            }
            
            // Clear form
            form.reset();
            
            // Refresh properties list
            loadUserProperties();
            
            // Show success message
            showAlert('Property added successfully!', 'success');
        }
    } catch (error) {
        console.error('Error adding property:', error);
        showAlert('Error adding property. Please try again.', 'danger');
    }
}

// ‚úÖ IMPLEMENTED: Generate AI content for a specific property
async function generateContentForProperty(propertyId) {
    try {
        if (!propertyId || propertyId === 'unknown') {
            showAlert('Please select a valid property first', 'warning');
            return;
        }

        const token = localStorage.getItem('access_token');
        if (!token) {
            showAlert('No access token found. Please login again.', 'danger');
            return;
        }

        // ‚úÖ Get selected languages from checkboxes
        const selectedLanguages = [];
        document.querySelectorAll('input[name="languages[]"]:checked').forEach(checkbox => {
            selectedLanguages.push(checkbox.value);
        });

        if (selectedLanguages.length === 0) {
            showAlert('Please select at least one language', 'warning');
            return;
        }

        // ‚úÖ Get content template and tone
        const templateSelect = document.getElementById('contentTemplate');
        const toneSelect = document.getElementById('contentTone');
        
        const template = templateSelect ? templateSelect.value : 'just_listed';
        const tone = toneSelect ? toneSelect.value : 'Professional';

        showAlert('Generating AI content...', 'info');

        // Call the AI content generation API with selected languages
        const response = await fetch('/api/v1/listings/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                property_id: propertyId,
                languages: selectedLanguages, // ‚úÖ Send selected languages
                template: template,
                tone: tone
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Show the generated content with language tabs
                showGeneratedContentWithLanguages(result.content, propertyId, selectedLanguages);
                showAlert('AI content generated successfully!', 'success');
            } else {
                showAlert(result.message || 'Failed to generate content', 'danger');
            }
        } else {
            const errorData = await response.json();
            showAlert(errorData.detail || 'Failed to generate content', 'danger');
        }
    } catch (error) {
        console.error('Error generating content:', error);
        showAlert('Error generating content. Please try again.', 'danger');
    }
}

// ‚úÖ NEW FUNCTION: Show generated content with language tabs
function showGeneratedContentWithLanguages(content, propertyId, languages) {
    // Create modal HTML with language tabs
    const modalHTML = `
        <div class="modal fade" id="generatedContentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">AI Generated Content</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Language Tabs -->
                        <ul class="nav nav-tabs" id="languageTabs" role="tablist">
                            ${languages.map((lang, index) => `
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link ${index === 0 ? 'active' : ''}" 
                                            id="tab-${lang.toLowerCase()}" 
                                            data-bs-toggle="tab" 
                                            data-bs-target="#content-${lang.toLowerCase()}" 
                                            type="button" 
                                            role="tab">
                                        ${getLanguageEmoji(lang)} ${lang}
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content mt-3" id="languageTabContent">
                            ${languages.map((lang, index) => {
                                const langContent = content[lang] || content[lang.toLowerCase()] || {};
                                const caption = langContent.caption || 'Content not available';
                                const hashtags = langContent.hashtags || [];
                                const cta = langContent.suggested_cta || '';
                                
                                return `
                                    <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                                         id="content-${lang.toLowerCase()}" 
                                         role="tabpanel">
                                        <div class="content-section mb-3">
                                            <h6 class="text-primary">Generated Content</h6>
                                            <textarea class="form-control" rows="6" readonly>${caption}</textarea>
                                        </div>
                                        
                                        <div class="content-section mb-3">
                                            <h6 class="text-primary">Hashtags</h6>
                                            <div class="hashtags-container">
                                                ${hashtags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                                            </div>
                                        </div>
                                        
                                        <div class="content-section mb-3">
                                            <h6 class="text-primary">Call to Action</h6>
                                            <p class="text-muted">${cta}</p>
                                        </div>
                                        
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-outline-primary me-2" onclick="copyToClipboard('${caption.replace(/'/g, "\\'")}')">
                                                <i class="fas fa-copy me-1"></i>Copy Content
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="postToFacebook('${lang}', '${caption.replace(/'/g, "\\'")}', '${propertyId}')">
                                                <i class="fab fa-facebook me-1"></i>Post to Facebook
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('generatedContentModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('generatedContentModal'));
    modal.show();
}

// ‚úÖ NEW FUNCTION: Get language emoji
function getLanguageEmoji(language) {
    const emojiMap = {
        'English': 'üá∫üá∏',
        'Hindi': 'üáÆüá≥',
        'Marathi': 'üáÆüá≥',
        'Gujarati': 'üáÆüá≥',
        '‡§π‡§ø‡§Ç‡§¶‡•Ä': 'üáÆüá≥',
        '‡§Æ‡§∞‡§æ‡§†‡•Ä': 'üáÆüá≥',
        '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä': 'üáÆüá≥'
    };
    return emojiMap[language] || 'üåê';
}

// ‚úÖ NEW FUNCTION: Copy content to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showAlert('Content copied to clipboard!', 'success');
    }).catch(() => {
        showAlert('Failed to copy content', 'danger');
    });
}

// ‚úÖ NEW FUNCTION: Post content to Facebook
async function postToFacebook(language, content, propertyId) {
    try {
        const token = localStorage.getItem('access_token');
        if (!token) {
            showAlert('No access token found. Please login again.', 'danger');
            return;
        }

        showAlert(`Posting ${language} content to Facebook...`, 'info');

        const response = await fetch('/api/v1/facebook/post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                property_id: propertyId,
                content: content,
                language: language
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showAlert(`${language} content posted to Facebook successfully!`, 'success');
            } else {
                showAlert(result.message || 'Failed to post to Facebook', 'danger');
            }
        } else {
            const errorData = await response.json();
            showAlert(errorData.detail || 'Failed to post to Facebook', 'danger');
        }
    } catch (error) {
        console.error('Error posting to Facebook:', error);
        showAlert('Error posting to Facebook. Please try again.', 'danger');
    }
}

// ‚úÖ ENHANCED: Generate AI Content with Branding (from reference script)
async function generateAIContentWithBranding(propertyId, language, tone, template) {
    try {
        // Show loading state
        const generateBtn = document.getElementById('generateContentBtn');
        if (generateBtn) {
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            generateBtn.disabled = true;
        }
        
        // Get selected languages
        const selectedLanguages = [];
        document.querySelectorAll('input[name="languages[]"]:checked').forEach(checkbox => {
            selectedLanguages.push(checkbox.value);
        });

        if (selectedLanguages.length === 0) {
            showAlert('Please select at least one language', 'warning');
            return;
        }

        // Generate base content
        const response = await fetch('/api/v1/listings/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify({
                property_id: propertyId,
                languages: selectedLanguages,
                tone: tone,
                template: template
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            let content = result.content || result.message || 'Content generated successfully';
            
            // Enhance content with user branding
            const brandedContent = generateContentWithBranding(content, language);
            
            // Display the branded content
            const contentDisplay = document.getElementById('generatedContent');
            if (contentDisplay) {
                contentDisplay.value = brandedContent;
                contentDisplay.style.display = 'block';
            }
            
            // Show success message
            showAlert('üéØ AI content generated with your branding!', 'success');
            
            // Enable Facebook posting if user has completed onboarding
            if (userProfile && userProfile.company) {
                const postToFacebookSection = document.getElementById('postToFacebookSection');
                if (postToFacebookSection) {
                    postToFacebookSection.style.display = 'block';
                }
            }
            
        } else {
            const error = await response.json();
            showAlert(`‚ùå Content generation failed: ${error.detail || 'Unknown error'}`, 'danger');
        }
        
    } catch (error) {
        console.error('Error generating content:', error);
        showAlert('‚ùå Error generating content. Please try again.', 'danger');
    } finally {
        // Reset button
        const generateBtn = document.getElementById('generateContentBtn');
        if (generateBtn) {
            generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate AI Content';
            generateBtn.disabled = false;
        }
    }
}

// ‚úÖ ENHANCED: Content generation with user branding
function generateContentWithBranding(baseContent, language = 'English') {
    if (!userProfile) {
        return baseContent;
    }
    
    let brandedContent = baseContent;
    
    // Add user's tagline if available
    if (userProfile.tagline) {
        brandedContent += `\n\n${userProfile.tagline}`;
    }
    
    // Add contact information
    let contactInfo = '';
    if (userProfile.phone) {
        contactInfo += `üìû ${userProfile.phone}`;
    }
    if (userProfile.whatsapp) {
        contactInfo += contactInfo ? ` | üì± ${userProfile.whatsapp}` : `üì± ${userProfile.whatsapp}`;
    }
    if (userProfile.email) {
        contactInfo += contactInfo ? ` | ‚úâÔ∏è ${userProfile.email}` : `‚úâÔ∏è ${userProfile.email}`;
    }
    
    if (contactInfo) {
        brandedContent += `\n\n${contactInfo}`;
    }
    
    // Add company info if available
    if (userProfile.company) {
        brandedContent += `\nüè¢ ${userProfile.company}`;
    }
    
    // Add experience if available
    if (userProfile.experience_years && userProfile.experience_years > 0) {
        brandedContent += `\n‚≠ê ${userProfile.experience_years}+ years of experience`;
    }
    
    // Add specialization areas if available
    if (userProfile.specialization_areas) {
        brandedContent += `\nüìç Specializing in: ${userProfile.specialization_areas}`;
    }
    
    return brandedContent;
}

// ‚úÖ NEW FUNCTION: Compare property data with type-aware comparison
function comparePropertyData(originalData, retrievedData, keyFields = ['title', 'type', 'bedrooms', 'price', 'city']) {
    const mismatches = [];
    
    for (const field of keyFields) {
        const originalValue = originalData[field];
        const retrievedValue = retrievedData[field];
        
        if (originalValue !== undefined && retrievedValue !== undefined) {
            // Handle numeric type differences
            let isEqual = false;
            
            if (typeof originalValue === 'number' && typeof retrievedValue === 'number') {
                // Both are numbers - compare directly
                isEqual = originalValue === retrievedValue;
            } else if (typeof originalValue === 'string' && typeof retrievedValue === 'string') {
                // Both are strings - compare directly
                isEqual = originalValue === retrievedValue;
            } else if (typeof originalValue === 'number' && typeof retrievedValue === 'string') {
                // Original is number, retrieved is string - try parsing
                const parsedRetrieved = parseFloat(retrievedValue);
                isEqual = !isNaN(parsedRetrieved) && originalValue === parsedRetrieved;
            } else if (typeof originalValue === 'string' && typeof retrievedValue === 'number') {
                // Original is string, retrieved is number - try parsing
                const parsedOriginal = parseFloat(originalValue);
                isEqual = !isNaN(parsedOriginal) && parsedOriginal === retrievedValue;
            } else {
                // Different types - convert both to strings for comparison
                isEqual = String(originalValue) === String(retrievedValue);
            }
            
            if (!isEqual) {
                mismatches.push({
                    field,
                    original: originalValue,
                    retrieved: retrievedValue,
                    originalType: typeof originalValue,
                    retrievedType: typeof retrievedValue
                });
            }
        }
    }
    
    return {
        isConsistent: mismatches.length === 0,
        mismatches,
        totalFields: keyFields.length,
        matchingFields: keyFields.length - mismatches.length
    };
}

// ‚úÖ ENHANCED: Validate property data consistency
function validatePropertyDataConsistency(propertyData) {
    console.log('üîç Validating property data consistency...');
    
    // Check for required fields
    const requiredFields = ['title', 'type', 'bedrooms', 'price', 'city'];
    const missingFields = requiredFields.filter(field => !propertyData[field]);
    
    if (missingFields.length > 0) {
        console.warn(`‚ö†Ô∏è Missing required fields: ${missingFields.join(', ')}`);
        return false;
    }
    
    // Check data types
    const typeValidation = {
        title: typeof propertyData.title === 'string',
        type: typeof propertyData.type === 'string',
        bedrooms: typeof propertyData.bedrooms === 'string' || typeof propertyData.bedrooms === 'number',
        price: typeof propertyData.price === 'number' || typeof propertyData.price === 'string',
        city: typeof propertyData.city === 'string'
    };
    
    const invalidTypes = Object.entries(typeValidation)
        .filter(([field, isValid]) => !isValid)
        .map(([field]) => field);
    
    if (invalidTypes.length > 0) {
        console.warn(`‚ö†Ô∏è Invalid data types for fields: ${invalidTypes.join(', ')}`);
        return false;
    }
    
    console.log('‚úÖ Property data validation passed');
    return true;
}

// ‚úÖ NEW FUNCTION: Quick Start functionality
function showQuickStart() {
    showSection('welcome');
    
    // Show quick start guide
    const quickStartGuide = `
        <div class="quick-start-guide mt-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="glass-card p-4 text-center">
                        <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                        <h4>üöÄ Quick Start Guide</h4>
                        <p class="text-muted">Get up and running in minutes!</p>
                        <button class="btn btn-primary" onclick="startQuickSetup()">
                            <i class="fas fa-play me-2"></i>Start Quick Setup
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="glass-card p-4">
                        <h5><i class="fas fa-list-check me-2"></i>Quick Steps:</h5>
                        <ol class="text-muted">
                            <li>Complete your profile</li>
                            <li>Connect Facebook account</li>
                            <li>Add your first property</li>
                            <li>Generate AI content</li>
                            <li>Post to Facebook</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const welcomeSection = document.getElementById('welcome-section');
    if (welcomeSection) {
        const existingGuide = welcomeSection.querySelector('.quick-start-guide');
        if (existingGuide) {
            existingGuide.remove();
        }
        welcomeSection.insertAdjacentHTML('beforeend', quickStartGuide);
    }
}

// ‚úÖ NEW FUNCTION: Start quick setup
function startQuickSetup() {
    showSection('onboarding');
    showAlert('üöÄ Starting quick setup! Let\'s get you configured in minutes.', 'info');
}

// ‚úÖ NEW FUNCTION: Update branding display
function updateBrandingDisplay() {
    if (!userProfile) return;
    
    // Update company name in header
    const companyName = userProfile.company || 'Your Company';
    updateCompanyHeader(companyName);
    
    // Update logo if available
    if (userProfile.logo_url) {
        updateCompanyLogo(userProfile.logo_url);
    }
    
    // Update welcome message
    const welcomeTitle = document.querySelector('.dashboard-welcome h1');
    if (welcomeTitle && userProfile.name) {
        welcomeTitle.textContent = `Welcome back, ${userProfile.name}!`;
    }
    
    // Update company info
    const companyInfo = document.querySelector('.company-info');
    if (companyInfo && userProfile.company) {
        companyInfo.textContent = userProfile.company;
    }
}

// ‚úÖ NEW FUNCTION: Update company header across all pages
function updateCompanyHeader(companyName) {
    // Update navbar brand
    const navbarBrand = document.querySelector('.navbar-brand');
    if (navbarBrand && companyName) {
        navbarBrand.innerHTML = `<i class="fas fa-building me-2"></i>${companyName}`;
    }
    
    // Update page titles
    const pageTitle = document.querySelector('title');
    if (pageTitle && companyName) {
        pageTitle.textContent = `${companyName} - PropertyAI Dashboard`;
    }
    
    // Update any company name placeholders
    document.querySelectorAll('.company-name-placeholder').forEach(el => {
        el.textContent = companyName;
    });
    
    // Update company tagline if available
    if (userProfile && userProfile.tagline) {
        document.querySelectorAll('.company-tagline-placeholder').forEach(el => {
            el.textContent = userProfile.tagline;
        });
    }
}

// ‚úÖ NEW FUNCTION: Update company logo
function updateCompanyLogo(logoUrl) {
    // Update navbar logo
    const navbarBrand = document.querySelector('.navbar-brand');
    if (navbarBrand && logoUrl) {
        navbarBrand.innerHTML = `<img src="${logoUrl}" alt="Company Logo" height="30" class="me-2">${navbarBrand.textContent}`;
    }
}

// Show alert function
function showAlert(message, type = 'info') {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to page
    const container = document.querySelector('.container-fluid');
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ PropertyAI Dashboard Initialized');
    
    // Handle OAuth callback FIRST to get token
    handleOAuthCallback();
    
    // Handle URL hash to prevent empty page
    const hash = window.location.hash;
    if (hash) {
        console.log('üîß Removing hash from URL:', hash);
        // Remove hash from URL without refreshing page
        history.replaceState(null, null, window.location.pathname + window.location.search);
        // Force a small delay to ensure hash is removed before proceeding
        setTimeout(() => {
            console.log('‚úÖ Hash removed, proceeding with initialization');
            initializeDashboard();
        }, 100);
    } else {
        // No hash, initialize immediately
        initializeDashboard();
    }
});

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    // Prevent hash-related navigation issues
    if (window.location.hash) {
        console.log('üîß Popstate: Removing hash from URL');
        history.replaceState(null, null, window.location.pathname + window.location.search);
    }
});

// Separate initialization function
function initializeDashboard() {
    // Load initial data
    loadUserProfile();
    loadDashboardStats();
    loadFacebookStatus();
    
    // Update branding display
    updateBrandingDisplay();
    
    // Show welcome section by default
    showSection('welcome');
    
    // ‚úÖ Show Quick Start guide
    showQuickStart();
}

// Placeholder functions for other features
function loadFacebookPages() { console.log('Facebook pages loading...'); }
function loadFacebookStatus() { console.log('Facebook status loading...'); }
function loadPostingHistory() { console.log('Posting history loading...'); }
function loadLeads() { console.log('Leads loading...'); }
function initOnboarding() { console.log('Onboarding initialized...'); }
function loadUserProfile() { console.log('User profile loading...'); }
function updateBrandingDisplay() { console.log('Branding updated...'); }
function editProperty(id) { showAlert(`Edit property ${id} - Coming soon!`, 'info'); }
function deleteProperty(id) { showAlert(`Delete property ${id} - Coming soon!`, 'info'); }
function hideAddPropertyModal() { console.log('Modal hidden'); }

// ‚úÖ ADDED: Missing onboarding functions
function loadUserProfileIntoOnboardingForm() { 
    console.log('Loading user profile into onboarding form...');
    // Load saved onboarding data if available
    loadOnboardingFormData();
}

function loadOnboardingFormData() { 
    console.log('Loading onboarding form data...');
    try {
        const savedData = localStorage.getItem('onboardingData');
        if (savedData) {
            const data = JSON.parse(savedData);
            console.log('‚úÖ Loaded saved onboarding data:', data);
            
            // Populate form fields with saved data
            Object.keys(data).forEach(key => {
                const element = document.querySelector(`[name="${key}"]`);
                if (element) {
                    element.value = data[key];
                }
            });
            
            // Handle checkboxes for languages
            if (data.languages && Array.isArray(data.languages)) {
                data.languages.forEach(lang => {
                    const checkbox = document.querySelector(`input[name="languages[]"][value="${lang}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            showAlert('‚úÖ Onboarding data loaded from previous session', 'success');
        }
    } catch (error) {
        console.error('Error loading onboarding data:', error);
    }
}

function saveOnboardingFormData() {
    try {
        const form = document.getElementById('onboardingForm');
        if (!form) return;
        
        const formData = new FormData(form);
        const data = {};
        
        // Collect all form data
        for (let [key, value] of formData.entries()) {
            if (key === 'languages[]') {
                if (!data.languages) data.languages = [];
                data.languages.push(value);
            } else {
                data[key] = value;
            }
        }
        
        // Save to localStorage
        localStorage.setItem('onboardingData', JSON.stringify(data));
        console.log('‚úÖ Onboarding data saved:', data);
        
    } catch (error) {
        console.error('Error saving onboarding data:', error);
    }
}

// ‚úÖ ENHANCED: Initialize onboarding with proper step management
function initOnboarding() {
    console.log('Initializing onboarding...');
    
    // Load saved step or start from step 1
    const savedStep = localStorage.getItem('onboardingStep') || '1';
    const currentStep = parseInt(savedStep);
    
    // Show current step
    showOnboardingStep(currentStep);
    
    // Update progress and navigation
    updateOnboardingProgress();
    updateOnboardingNavigation();
    
    // Setup form auto-save
    setupOnboardingAutoSave();
    
    console.log(`‚úÖ Onboarding initialized at step ${currentStep}`);
}

// ‚úÖ FIXED: Show specific onboarding step with proper validation
function showOnboardingStep(stepNumber) {
    console.log(`üéØ Showing onboarding step ${stepNumber}`);
    
    // Validate step number
    if (stepNumber < 1 || stepNumber > 7) {
        stepNumber = 1;
    }
    
    // Hide all steps
    document.querySelectorAll('.onboarding-step').forEach(step => {
        step.classList.remove('active');
        step.style.display = 'none';
    });
    
    // Show current step
    const currentStepElement = document.getElementById(`step${stepNumber}`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
        currentStepElement.style.display = 'block';
        localStorage.setItem('onboardingStep', stepNumber.toString());
        
        // Update progress and navigation
        updateOnboardingProgress();
        updateOnboardingNavigation();
        
        console.log(`‚úÖ Step ${stepNumber} displayed successfully`);
    } else {
        console.error(`‚ùå Step ${stepNumber} element not found`);
    }
}

// ‚úÖ FIXED: Navigate to next onboarding step with validation
function nextOnboardingStep() {
    const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
    console.log(`üîÑ Navigating from step ${currentStep} to next step`);
    
    // Validate current step data before proceeding
    if (!validateCurrentStep(currentStep)) {
        return;
    }
    
    if (currentStep < 7) {
        showOnboardingStep(currentStep + 1);
    } else {
        // Already on last step, don't navigate further
        console.log('‚úÖ Already on last step (7)');
    }
}

// ‚úÖ FIXED: Navigate to previous onboarding step
function prevOnboardingStep() {
    const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
    console.log(`üîÑ Navigating from step ${currentStep} to previous step`);
    
    if (currentStep > 1) {
        showOnboardingStep(currentStep - 1);
    }
}

// ‚úÖ NEW FUNCTION: Validate current step data
function validateCurrentStep(stepNumber) {
    console.log(`üîç Validating step ${stepNumber}`);
    
    switch(stepNumber) {
        case 1: // Personal Information
            const name = document.querySelector('input[name="name"]')?.value;
            const email = document.querySelector('input[name="email"]')?.value;
            const phone = document.querySelector('input[name="phone"]')?.value;
            
            if (!name || !email || !phone) {
                showAlert('Please fill in all required fields (Name, Email, Phone)', 'warning');
                return false;
            }
            break;
            
        case 2: // Company Details
            const company = document.querySelector('input[name="company"]')?.value;
            const experience = document.querySelector('select[name="experience_years"]')?.value;
            const specialization = document.querySelector('input[name="specialization_areas"]')?.value;
            const languages = document.querySelectorAll('input[name="languages[]"]:checked');
            
            if (!company || !experience || !specialization) {
                showAlert('Please fill in all required company details', 'warning');
                return false;
            }
            
            if (languages.length === 0) {
                showAlert('Please select at least one language', 'warning');
                return false;
            }
            break;
            
        case 3: // AI Branding
            const tagline = document.querySelector('input[name="tagline"]')?.value;
            if (!tagline) {
                showAlert('Please generate AI branding first', 'warning');
                return false;
            }
            break;
            
        case 4: // Facebook Integration
            // Facebook step is optional, can be skipped
            break;
            
        case 5: // RERA Compliance
            const businessType = document.querySelector('select[name="business_type"]')?.value;
            if (!businessType) {
                showAlert('Please select your business type', 'warning');
                return false;
            }
            break;
            
        case 6: // Profile Setup
            // Profile setup is optional
            break;
            
        case 7: // Completion
            const terms = document.getElementById('termsAgreement')?.checked;
            if (!terms) {
                showAlert('Please agree to the terms and conditions', 'warning');
                return false;
            }
            break;
    }
    
    return true;
}

// ‚úÖ FIXED: Update onboarding progress with proper step calculation
function updateOnboardingProgress() { 
    console.log('Updating onboarding progress...');
    try {
        const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
        const totalSteps = 7;
        const progress = (currentStep / totalSteps) * 100;
        
        const progressBar = document.getElementById('onboardingProgress');
        const stepText = document.getElementById('onboardingStepText');
        
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', currentStep);
        }
        
        if (stepText) {
            const stepNames = [
                'Personal Information',
                'Company Details', 
                'AI Branding',
                'Facebook Integration',
                'Legal Compliance',
                'Profile Setup',
                'Complete Setup'
            ];
            stepText.textContent = stepNames[currentStep - 1] || `Step ${currentStep}`;
        }
        
        console.log(`‚úÖ Progress updated: Step ${currentStep}/${totalSteps} (${progress}%)`);
    } catch (error) {
        console.error('Error updating progress:', error);
    }
}

// ‚úÖ FIXED: Update onboarding navigation buttons
function updateOnboardingNavigation() { 
    console.log('Updating onboarding navigation...');
    try {
        const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
        const prevBtn = document.getElementById('prevOnboardingBtn');
        const nextBtn = document.getElementById('nextOnboardingBtn');
        const completeSection = document.getElementById('completeOnboardingSection');
        
        if (prevBtn) {
            prevBtn.disabled = currentStep <= 1;
            if (currentStep <= 1) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
        }
        
        if (nextBtn) {
            if (currentStep >= 7) {
                // Hide next button and show complete section on last step
                nextBtn.style.display = 'none';
                if (completeSection) {
                    completeSection.style.display = 'block';
                }
            } else {
                // Show next button and hide complete section
                nextBtn.style.display = 'block';
                if (completeSection) {
                    completeSection.style.display = 'none';
                }
                nextBtn.innerHTML = 'Next<i class="fas fa-arrow-right ms-2"></i>';
                nextBtn.classList.remove('btn-success');
                nextBtn.classList.add('btn-primary');
            }
        }
        
        console.log(`‚úÖ Navigation updated for step ${currentStep}`);
    } catch (error) {
        console.error('Error updating navigation:', error);
    }
}

// ‚úÖ ENHANCED: Handle Facebook OAuth callback to complete onboarding
function handleFacebookOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const auth = urlParams.get('auth');
    const token = urlParams.get('token');
    const fromOnboarding = urlParams.get('fromOnboarding');
    
    if (auth === 'success' && token) {
        console.log('üîê OAuth success, storing token');
        localStorage.setItem('access_token', token);
        
        // Clean up URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // If coming from onboarding, complete the Facebook step
        if (fromOnboarding === 'true') {
            console.log('üîÑ Facebook OAuth completed during onboarding');
            
            // Mark Facebook step as completed
            const facebookStatus = document.getElementById('facebookStatus');
            if (facebookStatus) {
                facebookStatus.style.display = 'block';
            }
            
            // Hide Facebook setup forms
            const quickSetup = document.getElementById('facebookQuickSetup');
            const customSetup = document.getElementById('facebookCustomSetup');
            if (quickSetup) quickSetup.style.display = 'none';
            if (customSetup) customSetup.style.display = 'none';
            
            // Show success message
            showAlert('‚úÖ Facebook connected successfully! You can now proceed to the next step.', 'success');
            
            // Auto-save onboarding data
            saveOnboardingFormData();
            
            // Stay on onboarding step 4 (Facebook Integration)
            showOnboardingStep(4);
            
        } else {
            // Regular OAuth callback - go to dashboard
            console.log('üîê Regular OAuth callback, going to dashboard');
            showSection('welcome');
        }
        
        // Extract user info from token
        try {
            const tokenParts = token.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                console.log('‚úÖ Token stored, user_id:', payload.user_id);
            }
        } catch (e) {
            console.warn('Failed to decode token payload');
        }
    } else {
        console.log('No OAuth callback detected');
    }
}

// ‚úÖ ENHANCED: Setup Facebook Quick Setup with onboarding context
function setupFacebookQuick() {
    const quickSetup = document.getElementById('facebookQuickSetup');
    const customSetup = document.getElementById('facebookCustomSetup');
    
    if (quickSetup) quickSetup.style.display = 'block';
    if (customSetup) customSetup.style.display = 'none';
    
    // Setup the connect button event listener
    const connectBtn = document.getElementById('connectFacebookBtn');
    if (connectBtn) {
        connectBtn.onclick = async function() {
            try {
                // Show loading state
                connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connecting...';
                connectBtn.disabled = true;
                
                // Call Facebook OAuth endpoint with onboarding context
                const response = await fetch('/api/v1/facebook/oauth?fromOnboarding=true', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.oauth_url) {
                        // Redirect to Facebook OAuth with onboarding context
                        showAlert('Redirecting to Facebook for authorization...', 'info');
                        setTimeout(() => {
                            // Add fromOnboarding parameter to track context
                            const oauthUrl = new URL(data.oauth_url);
                            oauthUrl.searchParams.set('fromOnboarding', 'true');
                            window.location.href = oauthUrl.toString();
                        }, 1000);
                    } else {
                        throw new Error('No OAuth URL received');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Facebook connection error:', error);
                showAlert(`Connection failed: ${error.message}`, 'danger');
                
                // Reset button
                connectBtn.innerHTML = '<i class="fab fa-facebook me-2"></i>Connect Facebook Account';
                connectBtn.disabled = false;
            }
        };
    }
}

// ‚úÖ NEW FUNCTION: AI Branding Generation
function generateAIBranding() {
    const nameInput = document.querySelector('input[name="name"]');
    if (!nameInput || !nameInput.value) {
        showAlert('Please enter your name first', 'warning');
        return;
    }
    
    const name = nameInput.value;
    const generateBtn = document.getElementById('generateBranding');
    
    // Simulate AI branding generation
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    generateBtn.disabled = true;
    
    setTimeout(() => {
        const aiTagline = document.getElementById('aiTagline');
        const aiSocialBio = document.getElementById('aiSocialBio');
        const aiAbout = document.getElementById('aiAbout');
        const brandingResults = document.getElementById('brandingResults');
        
        if (aiTagline) aiTagline.value = `Your Trusted Real Estate Partner in ${name.split(' ')[0]}'s Success`;
        if (aiSocialBio) aiSocialBio.value = `Professional real estate agent helping families find their dream homes. Expert in residential and commercial properties.`;
        if (aiAbout) aiAbout.value = `With years of experience in the real estate market, I specialize in helping clients navigate the complexities of property transactions. My commitment to excellence and personalized service ensures that every client receives the attention they deserve.`;
        
        if (brandingResults) brandingResults.style.display = 'block';
        
        generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Regenerate Branding';
        generateBtn.disabled = false;
        
        showAlert('AI branding generated successfully!', 'success');
    }, 2000);
}

// ‚úÖ NEW FUNCTION: Setup Facebook Custom Setup
function setupFacebookCustom() {
    const quickSetup = document.getElementById('facebookQuickSetup');
    const customSetup = document.getElementById('facebookCustomSetup');
    
    if (quickSetup) quickSetup.style.display = 'none';
    if (customSetup) customSetup.style.display = 'block';
}

// ‚úÖ NEW FUNCTION: Skip Facebook Setup
function skipFacebookSetup() {
    const quickSetup = document.getElementById('facebookQuickSetup');
    const customSetup = document.getElementById('facebookCustomSetup');
    const status = document.getElementById('facebookStatus');
    
    if (quickSetup) quickSetup.style.display = 'none';
    if (customSetup) customSetup.style.display = 'none';
    if (status) status.style.display = 'block';
}

// ‚úÖ NEW FUNCTION: Test Facebook Config
function testFacebookConfig() {
    const appId = document.querySelector('input[name="facebook_app_id"]');
    const appSecret = document.querySelector('input[name="facebook_app_secret"]');
    
    if (!appId || !appId.value || !appSecret || !appSecret.value) {
        showAlert('Please enter both App ID and App Secret', 'warning');
        return;
    }
    
    // Simulate testing
    showAlert('Testing Facebook configuration...', 'info');
    setTimeout(() => {
        showAlert('Facebook configuration is valid!', 'success');
        const status = document.getElementById('facebookStatus');
        if (status) status.style.display = 'block';
    }, 1500);
}

// ‚úÖ NEW FUNCTION: Setup auto-save for onboarding form
function setupOnboardingAutoSave() {
    const form = document.getElementById('onboardingForm');
    if (!form) return;
    
    // Auto-save on input change
    form.addEventListener('input', function() {
        saveOnboardingFormData();
    });
    
    // Auto-save on checkbox change
    form.addEventListener('change', function() {
        saveOnboardingFormData();
    });
    
    console.log('‚úÖ Onboarding auto-save enabled');
}

// ‚úÖ ENHANCED: Submit onboarding with proper data handling
function submitOnboarding(event) {
    event.preventDefault();
    
    const termsCheckbox = document.getElementById('termsAgreement');
    if (!termsCheckbox || !termsCheckbox.checked) {
        showAlert('Please agree to the terms and conditions', 'warning');
        return;
    }
    
    // Show loading
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Completing...';
    submitBtn.disabled = true;
    
    try {
        // Get all form data
        const formData = new FormData(event.target);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (key === 'languages[]') {
                if (!data.languages) data.languages = [];
                data.languages.push(value);
            } else {
                data[key] = value;
            }
        }
        
        // Save to localStorage as completed profile
        localStorage.setItem('userProfile', JSON.stringify(data));
        localStorage.setItem('onboardingCompleted', 'true');
        localStorage.removeItem('onboardingData'); // Clean up temporary data
        localStorage.removeItem('onboardingStep'); // Clean up step data
        
        console.log('‚úÖ Onboarding completed, profile saved:', data);
        
        // Show success and redirect
        showAlert('üéâ Onboarding completed successfully!', 'success');
        
        setTimeout(() => {
            showSection('welcome');
            // Update user profile globally
            userProfile = data;
            updateBrandingDisplay();
        }, 1500);
        
    } catch (error) {
        console.error('Error completing onboarding:', error);
        showAlert('‚ùå Error completing onboarding. Please try again.', 'danger');
    } finally {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// ‚úÖ NEW FUNCTION: Logout
function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('user');
    window.location.href = '/';
}

</script>
