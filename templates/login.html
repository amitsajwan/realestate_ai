<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyAI - Login</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ✅ TEMPORARY: Inline styles for testing -->
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        body.login-page {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            width: 100%;
            max-width: 1000px;
        }
        
        .login-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }
        
        .login-header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .login-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .login-body {
            padding: 3rem 2rem;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            transition: 0.3s ease-in-out;
            position: relative;
            cursor: pointer;
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(31, 38, 135, 0.5);
        }
        
        .glass-card h4 {
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .glass-card p {
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: 0.15s ease-in-out;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-outline-primary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1f2937;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: 0.15s ease-in-out;
            background: white;
            color: #1f2937;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .alert-info {
            background: rgba(14, 165, 233, 0.1);
            color: #0ea5e9;
            border-left: 4px solid #0ea5e9;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .alert-info h5 {
            margin-bottom: 0.5rem;
            color: #0ea5e9;
        }
        
        .alert-info ul {
            margin-bottom: 0;
            padding-left: 1.5rem;
        }
        
        .alert-info li {
            margin-bottom: 0.25rem;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .text-primary { color: var(--primary) !important; }
        .text-secondary { color: #f59e0b !important; }
        .text-success { color: #10b981 !important; }
        .text-warning { color: #f59e0b !important; }
        .text-muted { color: #6b7280 !important; }
        
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mt-3 { margin-top: 1rem; }
        .me-2 { margin-right: 0.5rem; }
        .h-100 { height: 100%; }
        
        .d-flex { display: flex; }
        .d-grid { display: grid; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
        .text-start { text-align: left; }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -1rem;
            margin-left: -1rem;
        }
        
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding-right: 1rem;
            padding-left: 1rem;
        }
        
        @media (max-width: 768px) {
            .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            
            .login-container {
                margin: 1rem;
                border-radius: 16px;
            }
            
            .login-header, .login-body {
                padding: 2rem 1rem;
            }
            
            .login-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-header">
            <h1>🚀 Welcome to PropertyAI</h1>
            <p>Your AI-powered real estate assistant</p>
        </div>
        
        <div class="login-body">
            <!-- Step 1: Choose Login Method -->
            <div class="step-content active" id="step1">
                <h2>How would you like to get started?</h2>
                <p>Choose the option that works best for you. We'll guide you through the setup process.</p>
                
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="glass-card text-center h-100" onclick="selectOption('facebook')" style="cursor: pointer;">
                            <div class="mb-3">
                                <i class="fab fa-facebook text-primary" style="font-size: 3rem;"></i>
                            </div>
                            <h4>Facebook Login (Recommended)</h4>
                            <p class="text-muted">Quick and secure setup using your Facebook account. Perfect for real estate agents who want to post to Facebook pages.</p>
                            <div class="text-start">
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>One-click login</div>
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>Automatic Facebook page connection</div>
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>No password to remember</div>
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>Perfect for social media posting</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="glass-card text-center h-100" onclick="selectOption('email')" style="cursor: pointer;">
                            <div class="mb-3">
                                <i class="fas fa-envelope text-secondary" style="font-size: 3rem;"></i>
                            </div>
                            <h4>Email & Password</h4>
                            <p class="text-muted">Traditional email and password login. Good for users who prefer not to use social media accounts.</p>
                            <div class="text-start">
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>Traditional login method</div>
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>No social media required</div>
                                <div class="mb-2"><i class="fas fa-check text-success me-2"></i>Full control over account</div>
                                <div class="mb-2"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Manual Facebook setup needed</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-4">
                    <h5><i class="fas fa-info-circle me-2"></i>What happens next?</h5>
                    <ul class="mb-0">
                        <li><strong>Step 1:</strong> Choose your login method (you're here!)</li>
                        <li><strong>Step 2:</strong> Authenticate with Facebook or create email account</li>
                        <li><strong>Step 3:</strong> Complete your profile setup and connect Facebook pages</li>
                        <li><strong>Ready:</strong> Start adding properties and generating AI content!</li>
                    </ul>
                </div>
            </div>
            
            <!-- Step 2: Facebook Authentication -->
            <div class="step-content" id="step2" style="display: none;">
                <h2><i class="fab fa-facebook me-2"></i>Connect with Facebook</h2>
                <p>We'll redirect you to Facebook to securely authenticate your account.</p>
                
                <div class="glass-card">
                    <h4><i class="fab fa-facebook me-2"></i>Facebook Authentication Benefits</h4>
                    <p>This allows us to:</p>
                    <ul>
                        <li>Verify your identity securely</li>
                        <li>Access your Facebook pages for posting</li>
                        <li>Create your PropertyAI account automatically</li>
                        <li>Enable seamless social media integration</li>
                    </ul>
                    
                    <div class="d-flex gap-3 mt-4">
                        <button type="button" class="btn btn-outline-primary" onclick="goToOptions()">
                            <i class="fas fa-arrow-left me-2"></i> Back to Options
                        </button>
                        <button type="button" class="btn btn-primary btn-lg" onclick="loginWithFacebook()">
                            <i class="fab fa-facebook me-2"></i>Continue with Facebook
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Email Authentication -->
            <div class="step-content" id="step3" style="display: none;">
                <h2><i class="fas fa-envelope me-2"></i>Email Authentication</h2>
                <p>Create your PropertyAI account or sign in with existing credentials.</p>
                
                <div class="glass-card">
                    <!-- Toggle between Register and Login -->
                    <div class="mb-4">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="authMode" id="registerMode" checked>
                            <label class="btn btn-outline-primary" for="registerMode">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </label>
                            
                            <input type="radio" class="btn-check" name="authMode" id="loginMode">
                            <label class="btn btn-outline-primary" for="loginMode">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </label>
                        </div>
                    </div>
                    
                    <!-- Registration Form -->
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required minlength="6">
                            <small class="text-muted">Minimum 6 characters</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="termsAccepted" required>
                            <label class="form-check-label" for="termsAccepted">
                                I agree to the <a href="#" class="text-primary">Terms of Service</a> and <a href="#" class="text-primary">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                    </form>
                    
                    <!-- Login Form -->
                    <form id="loginForm" style="display: none;">
                        <div class="form-group">
                            <label for="loginEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </button>
                        </div>
                    </form>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button type="button" class="btn btn-outline-primary" onclick="goToOptions()">
                            <i class="fas fa-arrow-left me-2"></i>Go Back
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Profile Setup -->
            <div class="step-content" id="step4" style="display: none;">
                <h2><i class="fas fa-user-cog me-2"></i>Complete Your Profile Setup</h2>
                <p>Let's set up your real estate business profile to get the most out of PropertyAI.</p>
                
                <div class="glass-card">
                    <h4><i class="fas fa-user-cog me-2"></i>Profile Setup Benefits</h4>
                    <ul>
                        <li>Personalized AI content generation</li>
                        <li>Branded property listings</li>
                        <li>Facebook page integration</li>
                        <li>Professional business presence</li>
                    </ul>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary" onclick="startOnboarding()">
                            <i class="fas fa-rocket me-2"></i>Start Profile Setup
                        </button>
                        <button class="btn btn-outline-primary" onclick="skipToDashboard()">
                            <i class="fas fa-play me-2"></i>Skip for Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedOption = null;
        let currentStep = 1;
        
        function selectOption(option) {
            selectedOption = option;
            console.log('🎯 Selected option:', option);
            
            // Update visual selection
            document.querySelectorAll('.glass-card').forEach(card => {
                card.style.border = '1px solid var(--glass-border)';
                // Remove any existing selection indicators
                const existingCheck = card.querySelector('.selection-check');
                if (existingCheck) existingCheck.remove();
            });
            
            // Highlight selected option
            const selectedCard = event.currentTarget;
            selectedCard.style.border = '2px solid var(--primary)';
            
            // Add selection checkmark
            const checkmark = document.createElement('div');
            checkmark.className = 'selection-check';
            checkmark.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 1.5rem;"></i>';
            checkmark.style.position = 'absolute';
            checkmark.style.top = '1rem';
            checkmark.style.right = '1rem';
            selectedCard.style.position = 'relative';
            selectedCard.appendChild(checkmark);
            
            // Route to appropriate step based on selection
            setTimeout(() => {
                if (option === 'facebook') {
                    console.log('🔄 Going to Facebook authentication (step 2)');
                    currentStep = 2;
                    showStep(2);
                } else if (option === 'email') {
                    console.log('🔄 Going to Email authentication (step 3)');
                    currentStep = 3;
                    showStep(3);
                }
            }, 500);
        }
        
        function showStep(stepNumber) {
            console.log('📱 Showing step:', stepNumber);
            
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.style.display = 'none';
                step.classList.remove('active');
                console.log('❌ Hiding step:', step.id);
            });
            
            // Show current step
            const targetStep = document.getElementById(`step${stepNumber}`);
            if (targetStep) {
                targetStep.style.display = 'block';
                targetStep.classList.add('active');
                console.log('✅ Showing step:', targetStep.id);
                
                // Force display with !important if needed
                targetStep.style.setProperty('display', 'block', 'important');
            } else {
                console.error('❌ Step not found:', `step${stepNumber}`);
            }
        }
        
        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                console.log('➡️ Moving to step:', currentStep);
                showStep(currentStep);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                console.log('⬅️ Moving to step:', currentStep);
                showStep(currentStep);
            }
        }
        
        // ✅ ADDED: Function to go back to step 1 (option selection)
        function goToOptions() {
            console.log('🔄 Going back to options selection (step 1)');
            currentStep = 1;
            showStep(1);
        }
        
        async function loginWithFacebook() {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connecting...';
                button.disabled = true;
                
                // Call Facebook OAuth endpoint
                const response = await fetch('/api/v1/facebook/oauth');
                const oauthData = await response.json();
                
                if (oauthData.success && oauthData.oauth_url) {
                    // Redirect to the OAuth URL
                    window.location.href = oauthData.oauth_url;
                } else {
                    throw new Error('Failed to get OAuth URL');
                }
            } catch (error) {
                console.error('Facebook OAuth error:', error);
                alert('Failed to connect with Facebook. Please try again.');
                
                // Reset button
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        function startOnboarding() {
            // Redirect to onboarding page
            window.location.href = '/modern-onboarding';
        }
        
        function skipToDashboard() {
            // Redirect to dashboard
            window.location.href = '/dashboard';
        }
        
        // Handle form mode toggle
        document.getElementById('registerMode').addEventListener('change', function() {
            if (this.checked) {
                console.log('📝 Switching to Register mode');
                document.getElementById('registerForm').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                
                // Force display with !important
                document.getElementById('registerForm').style.setProperty('display', 'block', 'important');
                document.getElementById('loginForm').style.setProperty('display', 'none', 'important');
            }
        });
        
        document.getElementById('loginMode').addEventListener('change', function() {
            if (this.checked) {
                console.log('🔑 Switching to Login mode');
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                
                // Force display with !important
                document.getElementById('registerForm').style.setProperty('display', 'none', 'important');
                document.getElementById('loginForm').style.setProperty('display', 'block', 'important');
            }
        });
        
        // Handle registration form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        full_name: fullName
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Store token
                    localStorage.setItem('authToken', result.access_token);
                    alert('Account created successfully! Redirecting to profile setup...');
                    
                    // Proceed to step 4
                    nextStep();
                } else {
                    alert(result.detail || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
        });
        
        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Store token
                    localStorage.setItem('authToken', result.access_token);
                    alert('Login successful! Redirecting to dashboard...');
                    
                    // Redirect to dashboard
                    window.location.href = '/dashboard';
                } else {
                    alert(result.detail || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        });
        
        // Initialize first step
        console.log('🚀 Initializing login page...');
        showStep(1);
        
        // Debug: Check if all elements are present
        console.log('🔍 Debug: Checking page elements...');
        console.log('  - Step 1:', document.getElementById('step1'));
        console.log('  - Step 2:', document.getElementById('step2'));
        console.log('  - Step 3:', document.getElementById('step3'));
        console.log('  - Step 4:', document.getElementById('step4'));
        console.log('  - Register form:', document.getElementById('registerForm'));
        console.log('  - Login form:', document.getElementById('loginForm'));
        console.log('  - Register mode radio:', document.getElementById('registerMode'));
        console.log('  - Login mode radio:', document.getElementById('loginMode'));
        
        // Force first step to be visible
        const firstStep = document.getElementById('step1');
        if (firstStep) {
            firstStep.style.display = 'block';
            firstStep.classList.add('active');
            firstStep.style.setProperty('display', 'block', 'important');
            console.log('✅ First step forced to be visible');
        }
    </script>
</body>
</html>