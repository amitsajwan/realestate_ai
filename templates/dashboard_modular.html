<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyAI - Next-Gen AI Real Estate Dashboard</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Dashboard Styles -->
    <!-- Include next-generation styles -->
    {% include 'components/dashboard_styles_nextgen.html' %}
    
    <!-- Include component styles for compatibility -->
    {% include 'components/dashboard_styles.html' %}
</head>
<body>
    <!-- Dashboard Header -->
    {% include 'components/dashboard_header.html' %}
    
    <!-- Main Dashboard Content -->
    {% include 'components/dashboard_main.html' %}
    
    <!-- External JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard Scripts -->
    {% include 'components/dashboard_scripts.html' %}
    
    <!-- AI Content Generation Scripts -->
    <script>
        // AI Content Generation Functions
        async function generateAIContent() {
            const propertySelect = document.getElementById('propertySelect');
            const template = document.getElementById('contentTemplate').value;
            const tone = document.getElementById('contentTone').value;
            
            if (!propertySelect.value) {
                showAlert('Please select a property first', 'warning');
                return;
            }
            
            // Get selected languages
            const selectedLanguages = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedLanguages.push(checkbox.value);
            });
            
            if (selectedLanguages.length === 0) {
                showAlert('Please select at least one language', 'warning');
                return;
            }
            
            try {
                // Show loading state
                const generateBtn = document.querySelector('button[onclick="generateAIContent()"]');
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                
                // Generate content for each language
                const contentResults = {};
                
                for (const language of selectedLanguages) {
                    try {
                        console.log(`üéØ Generating content for ${language}...`);
                        
                        const response = await fetch('/api/v1/listings/generate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: JSON.stringify({
                                property_id: propertySelect.value,
                                language: language,
                                tone: tone,
                                template: template
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(`üìù API response for ${language}:`, result);
                            
                            // Handle different response formats
                            if (result.caption) {
                                contentResults[language] = result.caption;
                            } else if (result.content) {
                                contentResults[language] = result.content;
                            } else if (result.message) {
                                contentResults[language] = result.message;
                            } else if (result.detail) {
                                contentResults[language] = result.detail;
                            } else if (typeof result === 'string') {
                                contentResults[language] = result;
                            } else {
                                contentResults[language] = `Generated content for ${language}`;
                            }
                        } else {
                            console.error(`‚ùå API error for ${language}:`, response.status);
                            contentResults[language] = `Error generating content for ${language}`;
                        }
                    } catch (error) {
                        console.error(`‚ùå Error generating content for ${language}:`, error);
                        contentResults[language] = `Error generating content for ${language}`;
                    }
                }
                
                // Display generated content
                displayGeneratedContent(contentResults);
                
                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Content';
                
            } catch (error) {
                console.error('‚ùå Error in generateAIContent:', error);
                showAlert('Error generating content. Please try again.', 'error');
                
                // Reset button
                const generateBtn = document.querySelector('button[onclick="generateAIContent()"]');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Content';
            }
        }
        
        function displayGeneratedContent(contentResults) {
            const contentDisplay = document.getElementById('contentDisplay');
            if (!contentDisplay) {
                console.error('Content display element not found');
                return;
            }
            
            // Show the content display
            contentDisplay.style.display = 'block';
            
            let html = '<hr class="my-4"><h4 class="text-dark mb-3">Generated Content</h4><div class="row">';
            
            for (const [language, content] of Object.entries(contentResults)) {
                if (content && content.length > 0) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-language me-2"></i>${language}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="content-text mb-3">
                                        ${content.replace(/\n/g, '<br>')}
                                    </div>
                                    <div class="content-actions">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-copy me-1"></i>Copy
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="postToFacebook('${language}', '${content.replace(/'/g, "\\'")}')">
                                            <i class="fab fa-facebook me-1"></i>Post to FB
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            contentDisplay.innerHTML = html;
            
            // Show success message
            showAlert('Content generated successfully!', 'success');
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('Content copied to clipboard!', 'success');
                }).catch(() => {
                    showAlert('Failed to copy content', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('Content copied to clipboard!', 'success');
            }
        }
        
        async function postToFacebook(language, content) {
            try {
                // Get Facebook pages
                const response = await fetch('/api/v1/facebook/pages', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.pages && result.pages.length > 0) {
                        // For now, post to the first available page
                        const pageId = result.pages[0].id;
                        
                        const postResponse = await fetch('/api/v1/facebook/post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: JSON.stringify({
                                page_id: pageId,
                                message: content,
                                language: language
                            })
                        });
                        
                        if (postResponse.ok) {
                            const postResult = await postResponse.json();
                            if (postResult.success) {
                                showAlert(`Successfully posted to Facebook in ${language}!`, 'success');
                            } else {
                                showAlert(`Failed to post: ${postResult.error}`, 'error');
                            }
                        } else {
                            showAlert('Failed to post to Facebook', 'error');
                        }
                    } else {
                        showAlert('No Facebook pages available. Please connect your Facebook account first.', 'warning');
                    }
                } else {
                    showAlert('Failed to get Facebook pages', 'error');
                }
            } catch (error) {
                console.error('Error posting to Facebook:', error);
                showAlert('Error posting to Facebook. Please try again.', 'error');
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ PropertyAI Dashboard Initialized');
            
            // Load initial data
            loadDashboardStats();
            loadProperties();
            loadFacebookPages();
            
            // Show welcome section by default
            showSection('welcome');
        });
    </script>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="#" onclick="showSection('welcome')" class="mobile-nav-item active" id="mobile-nav-welcome">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" onclick="showSection('properties')" class="mobile-nav-item" id="mobile-nav-properties">
            <i class="fas fa-building"></i>
            <span>Properties</span>
        </a>
        <a href="#" onclick="showSection('ai-content')" class="mobile-nav-item" id="mobile-nav-ai-content">
            <i class="fas fa-robot"></i>
            <span>AI</span>
        </a>
        <a href="#" onclick="showSection('facebook')" class="mobile-nav-item" id="mobile-nav-facebook">
            <i class="fab fa-facebook"></i>
            <span>Social</span>
        </a>
        <a href="#" onclick="showSection('onboarding')" class="mobile-nav-item" id="mobile-nav-onboarding">
            <i class="fas fa-user-cog"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showSection('properties')" title="Add Property">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // Enhanced mobile navigation
        function updateMobileNav(activeSection) {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.getElementById(`mobile-nav-${activeSection}`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
        }

        // Override showSection to update mobile nav
        const originalShowSection = window.showSection;
        window.showSection = function(sectionName) {
            if (originalShowSection) {
                originalShowSection(sectionName);
            }
            updateMobileNav(sectionName);
        };

        // Next-gen toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-nextgen ${type}`;
            toast.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <div class="mt-1">${message}</div>
                    </div>
                    <button type="button" class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Replace alert with showToast
        window.showAlert = showToast;

        // Enhanced animations
        document.addEventListener('DOMContentLoaded', function() {
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.nextgen-card, .stat-card');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('fade-in');
            });
        });
    </script>
</body>
</html>
