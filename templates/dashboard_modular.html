<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyAI - Next-Gen AI Real Estate Dashboard</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ‚úÖ UNIFIED: Single CSS file for all styles -->
    {% include 'components/dashboard_styles_unified.html' %}
    
    <!-- ‚úÖ VISIBILITY FIX: JavaScript for dashboard visibility -->
    <script src="/static/js/dashboard-visibility-fix.js"></script>
</head>
<body class="nextgen-enabled"> <!-- ‚úÖ Next-Gen mode always enabled -->
    <!-- EXISTING Dashboard Header (Keep unchanged) -->
    {% include 'components/dashboard_header.html' %}
    
    <!-- EXISTING Main Dashboard Content (Keep unchanged) -->
    {% include 'components/dashboard_main.html' %}
    
            <!-- Property Form Section -->
        {% include 'components/dashboard_property_form.html' %}
        
        <!-- Facebook Integration Section -->
        {% include 'components/dashboard_facebook.html' %}
        
        <!-- Analytics Section -->
        {% include 'components/dashboard_analytics.html' %}
        
        <!-- CRM Section -->
        {% include 'components/dashboard_crm.html' %}
    
    <!-- ‚úÖ Next-Gen Bottom Navigation (Always visible) -->
    <nav class="nextgen-bottom-nav" id="nextgenBottomNav">
        <a href="#" class="nextgen-nav-item active" onclick="showSection('welcome')">
            <div><i class="fas fa-home"></i></div>
            <div style="font-size: 0.75rem;">Home</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('properties')">
            <div><i class="fas fa-building"></i></div>
            <div style="font-size: 0.75rem;">Properties</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('property-form')">
            <div><i class="fas fa-plus"></i></div>
            <div style="font-size: 0.75rem;">Add Property</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('analytics')">
            <div><i class="fas fa-chart-bar"></i></div>
            <div style="font-size: 0.75rem;">Analytics</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('crm')">
            <div><i class="fas fa-users"></i></div>
            <div style="font-size: 0.75rem;">CRM</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('ai-content')">
            <div><i class="fas fa-robot"></i></div>
            <div style="font-size: 0.75rem;">AI Tools</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('facebook')">
            <div><i class="fas fa-share-alt"></i></div>
            <div style="font-size: 0.75rem;">Social</div>
        </a>
        <a href="#" class="nextgen-nav-item" onclick="showSection('onboarding')">
            <div><i class="fas fa-user"></i></div>
            <div style="font-size: 0.75rem;">Profile</div>
        </a>
    </nav>

    <!-- ‚úÖ Next-Gen FAB (Always visible) -->
    <button class="nextgen-fab" id="nextgenFAB" onclick="showSection('properties')">
        <i class="fas fa-plus"></i>
    </button>

    <!-- ‚úÖ Next-Gen Background (Always visible) -->
    <div class="nextgen-bg" id="nextgenBg"></div>
    
    <!-- EXISTING External JavaScript (Keep unchanged) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ‚úÖ SIMPLIFIED: Only essential JavaScript files (in correct dependency order) -->
    <script src="/static/js/dashboard_scripts_clean.js"></script>
    <script src="/static/js/dashboard_property.js"></script>
    <script src="/static/js/dashboard_core.js"></script>
    <script src="/static/js/dashboard_functions.js"></script>
    <script src="/static/js/dashboard_init.js"></script>
    
    <!-- ‚úÖ COMPLETE: All functionality now in external JavaScript files -->
    <!-- No inline JavaScript needed - all functions are in external files -->
    <script>
        // Simple section management - no conflicts
        function showSection(sectionName) {
            console.log('üéØ showSection called with: ' + sectionName);
            
            // Hide all sections
            const allSections = document.querySelectorAll('.dashboard-section');
            allSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log('‚úÖ Section displayed:', sectionName);
                
                        // Load section-specific data
                if (sectionName === 'onboarding') {
                    if (typeof showOnboardingSection === 'function') {
                        showOnboardingSection();
                    } else {
                        console.warn('‚ö†Ô∏è showOnboardingSection function not found, calling populateOnboardingForm directly');
                        populateOnboardingForm();
                    }
                } else if (sectionName === 'property-form') {
                    console.log('üè† Property form section displayed');
                }
            } else {
                console.error('‚ùå Section not found:', sectionName + '-section');
            }
        }
        
        // Essential onboarding functions - ensure they're available globally
        function nextOnboardingStep() {
            const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
            console.log('üîÑ Navigating from step ' + currentStep + ' to next step');
            
            if (currentStep < 7) {
                // Simple step navigation
                const nextStep = currentStep + 1;
                localStorage.setItem('onboardingStep', nextStep.toString());
                
                // Hide all steps
                document.querySelectorAll('.onboarding-step').forEach(step => {
                    step.style.display = 'none';
                });
                
                // Show next step
                const nextStepElement = document.getElementById('step' + nextStep);
                if (nextStepElement) {
                    nextStepElement.style.display = 'block';
                    console.log('‚úÖ Step ' + nextStep + ' displayed');
                }
                
                // Update progress
                const progress = (nextStep / 7) * 100;
                const progressBar = document.getElementById('onboardingProgress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            }
        }
        
        function prevOnboardingStep() {
            const currentStep = parseInt(localStorage.getItem('onboardingStep') || '1');
            if (currentStep > 1) {
                const prevStep = currentStep - 1;
                localStorage.setItem('onboardingStep', prevStep.toString());
                
                // Hide all steps
                document.querySelectorAll('.onboarding-step').forEach(step => {
                    step.style.display = 'none';
                });
                
                // Show previous step
                const prevStepElement = document.getElementById('step' + prevStep);
                if (prevStepElement) {
                    prevStepElement.style.display = 'block';
                }
                
                // Update progress
                const progress = (prevStep / 7) * 100;
                const progressBar = document.getElementById('onboardingProgress');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
            }
        }
        
        console.log('‚úÖ Essential onboarding functions loaded globally');
        console.log('üîç Function availability check:');
        console.log('  - nextOnboardingStep:', typeof nextOnboardingStep);
        console.log('  - prevOnboardingStep:', typeof prevOnboardingStep);
        console.log('  - populateOnboardingForm:', typeof populateOnboardingForm);
        console.log('  - showOnboardingSection:', typeof showOnboardingSection);
        
        // Function to show onboarding section and populate form
        function showOnboardingSection() {
            console.log('üéØ Showing onboarding section...');
            
            // Populate form with user data
            populateOnboardingForm();
            
            // Show first step
            const firstStep = document.getElementById('step1');
            if (firstStep) {
                firstStep.style.display = 'block';
            }
            
            // Setup auto-save
            setupSimpleAutoSave();
            
            console.log('‚úÖ Onboarding section displayed and populated');
        }
        
        // Simple function to populate onboarding form with user data
        function populateOnboardingForm() {
            console.log('üë§ Populating onboarding form with user data...');
            
            // Try to load from localStorage
            const userProfile = localStorage.getItem('userProfile');
            const onboardingData = localStorage.getItem('onboardingData');
            
            let data = null;
            if (onboardingData) {
                try {
                    data = JSON.parse(onboardingData);
                    console.log('‚úÖ Loaded onboarding data:', data);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Failed to parse onboarding data');
                }
            } else if (userProfile) {
                try {
                    data = JSON.parse(userProfile);
                    console.log('‚úÖ Loaded user profile data:', data);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Failed to parse user profile data');
                }
            }
            
            if (data) {
                // Populate form fields
                Object.keys(data).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = data[key];
                        console.log('‚úÖ Populated field:', key, '=', data[key]);
                    }
                });
                
                // Handle special cases
                if (data.languages && Array.isArray(data.languages)) {
                    data.languages.forEach(lang => {
                        const checkbox = document.querySelector(`input[name="languages[]"][value="${lang}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                if (data.business_type) {
                    const select = document.querySelector('select[name="business_type"]');
                    if (select) select.value = data.business_type;
                }
            } else {
                console.log('‚ÑπÔ∏è No user data found, form will start empty');
            }
        }
        
        // Simple auto-save function to prevent multiple calls
        let autoSaveEnabled = false;
        function setupSimpleAutoSave() {
            if (autoSaveEnabled) return;
            
            const form = document.getElementById('onboardingForm');
            if (!form) return;
            
            form.addEventListener('input', function() {
                saveOnboardingFormData();
            });
            
            form.addEventListener('change', function() {
                saveOnboardingFormData();
            });
            
            autoSaveEnabled = true;
            console.log('‚úÖ Simple auto-save enabled');
        }
        
        function saveOnboardingFormData() {
            try {
                const form = document.getElementById('onboardingForm');
                if (!form) return;
                
                const formData = new FormData(form);
                const data = {};
                
                for (let [key, value] of formData.entries()) {
                    if (key === 'languages[]') {
                        if (!data.languages) data.languages = [];
                        data.languages.push(value);
                    } else {
                        data[key] = value;
                    }
                }
                
                localStorage.setItem('onboardingData', JSON.stringify(data));
                console.log('‚úÖ Form data auto-saved');
                
            } catch (error) {
                console.error('‚ùå Error saving form data:', error);
            }
        }
        
        // Setup auto-save when onboarding is shown
        window.setupSimpleAutoSave = setupSimpleAutoSave;
        
        // Simple dashboard initialization
        function initializeDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Load user profile and stats
            if (typeof loadUserProfile === 'function') {
                loadUserProfile();
            }
            if (typeof loadDashboardStats === 'function') {
                loadDashboardStats();
            }
            
            // Show welcome section by default
            showSection('welcome');
            
            console.log('‚úÖ Dashboard initialized successfully');
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
        
        // Verify functions are loaded
        console.log('üîç Verifying onboarding functions are loaded:');
        console.log('  - nextOnboardingStep:', typeof nextOnboardingStep);
        console.log('  - prevOnboardingStep:', typeof prevOnboardingStep);
        console.log('  - showOnboardingSection:', typeof showOnboardingSection);
        console.log('  - populateOnboardingForm:', typeof populateOnboardingForm);
        console.log('  - setupSimpleAutoSave:', typeof setupSimpleAutoSave);
        
        // Test function availability in global scope
        console.log('üîç Global scope function check:');
        console.log('  - window.nextOnboardingStep:', typeof window.nextOnboardingStep);
        console.log('  - window.prevOnboardingStep:', typeof window.prevOnboardingStep);
        console.log('  - window.showOnboardingSection:', typeof window.showOnboardingSection);
    </script>
    
</body>
</html>